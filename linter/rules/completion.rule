#!/usr/bin/env bash
set -euo pipefail

# ----------------------------------------------------------------------
# üß™ Beargrease Linter Rule: Completion Log Check
# ----------------------------------------------------------------------
# 
# Verifies that the target script includes a final log statement signaling
# unambiguous successful completion
#
# Required format:
#
#   log_ts "‚úÖ [name-of-your-script.sh] completed successfully."
#
# The square brackets around the script name are **mandatory** to ensure
# visual consistency across Beargrease logs.
#
# Maintainer: Cabrillo Labs, Ltd. 2025
# License: MIT
# Version: 0.1.0
#
# ----------------------------------------------------------------------
#
# Exit Code Reference:
#   0   - Check passed
#   99  - Completion log missing#
# ----------------------------------------------------------------------
#
# Usage:
#   Called automatically by linter.sh. Not intended for direct use.
#
# Options:
#   None
#
# ----------------------------------------------------------------------

# ----------------------------------------------------------------------
# üêª Beargrease Linter Rule Environment Setup
# ----------------------------------------------------------------------

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LINTER_DIR="$SCRIPT_DIR"
ROOT_DIR="$(cd "$LINTER_DIR/../.." && pwd)"
SHARED_DIR="$ROOT_DIR/scripts/shared"

source "$SHARED_DIR/logging.sh"

# ----------------------------------------------------------------------
# üîç Completion Log Check
# ----------------------------------------------------------------------

log_ts "üîç Checking for final completion log..."

# Define the expected pattern.
# Use a flexible regex that matches:
# ‚úÖ [optional script name] completed successfully.

COMPLETION_PATTERN='‚úÖ.*completed successfully\.'

# Search the script for the completion log.
if ! grep -qE "$COMPLETION_PATTERN" "$TARGET_FILE"; then
  log_ts "‚ùå Completion log statement is missing."

  log_block <<EOF
üí° NEXT STEPS:
  1. Add a final log line to the end of your script to confirm successful execution.

     Example:

       log_ts "‚úÖ [name-of-your-script.sh] completed successfully."

  2. The square brackets around the script name are **required**. This maintains visual consistency in Beargrease logs.

  3. This ensures that all Beargrease scripts communicate a clear, unambiguous success state.

  4. Refer to Section 10: Completion in the Beargrease Shell Script Protocol and Style Guide.
EOF

  exit 99
fi

# ----------------------------------------------------------------------
# ‚úÖ Completion
# ----------------------------------------------------------------------

log_ts "‚úÖ Completion log check passed."